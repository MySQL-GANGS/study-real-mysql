# 데이터 압축
---
디스크에 저장된 데이터 파일의 크기
 - 쿼리 성능과 직결
 - InnoDB 버퍼 풀, 더티 페이지 사용횟수, 백업 시간, 복구 시간, 저장공간과 비용 문제도 직결된다. 

이를 해결하기 위해 데이터 압축 기능을 제공

MySQL 서버에서 사용하는 압축방식
 1. 테이블 압축
 2. 페이지 압축.

## 페이지 압축(Transparent Page Compresssion)
---
* MySQL 서버가 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장.
* MySQL 서버가 디스크에서 데이터 페이지를 읽어올 때 압축이 해제
* 16KB 데이터 페이지를 압축한 결과가 용량이 얼마나 될지 예측이 불가

1. 16KB 페이지를 압축(압축 결과를 7KB로 가정)
2. MySQL 서버는 디스크에 압축된 결과 7KB를 기록 ( 이때 MySQL 서버는 압축 데이터 7KB에 9KB이 빈 데이터를 기록)
3. 디스크에 데이터를 기록한 후, 7KB 이후의 공간 9KB에 대해 펀치 홀을 생성
4. 파일 시스템은 7KB만 남기고 나머지 디스크의 9KB공간은 다시 운영체제로 반납

그러나... MySQL서버의 페이지 압축의 펀치 홀 기능은 운영체제 뿐만 아니라 하드웨어 자체에서도 해당 기능을 지원해야 사용 가능하다는 점이다. 

그리고 파일시스템 관련 명령어가 펀치 홀을 지워나지 못하다는 것..

실제 페이지 압축은 많이 사용하지 않는 상태.. 사용하려면 COMPRESSION옵션을 설정

CREATE TABLE t1 (c1 INT) COMPRESSION="zlib";

## 테이블 압축
---
* 운영체제나 하드웨어에 대한 제약 없이 사용가능 -> 활용도가 높음

단점
* 버퍼 풀 공간 활용률이 낮음
* 쿼리 처리 성능이 낮음
* 빈번한 데이터 변경 시 압축률이 떨어짐

테이블 압축 전제조건 : 압축을 사용하려는 테이블이 별도의 테이블 스페이스를 사용 -> innodb_file_per_table 시스템 변수가 ON으로 설정.

테이블
* ROW_FORMAT=COMPRESSED옵션을 명시
* KEY_BLOCK_SIZE옵션 -> 압축된 페이지의 타깃 크기를 명시. 2n값.

1. 16KB의 데이터 페이지를 압축
   1. 압축된 겨로가가 8KB이하면 그대로 디스크에 저장(압축 완료)
   2. 압축된 결과가 8KB를 초과하면 원본페이지를 스플릿해서 2개의 페이지에 8KB씩 저장
2. 나뉜 페이지 각각에 대해 "1"번 단계를 반복 실행

반복 구문이므로 목표 크기의 적절한 설정이 중요하다. 

KEY_BLOCK_SIZE는 샘플 테스트를 거쳐서 결정하는 것이 좋다. 